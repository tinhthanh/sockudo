version: '3.8'

services:
  app:
    image: ${DOCKERHUB_USERNAME}/${SERVICE_NAME}:latest
    container_name: ${SERVICE_NAME}
    restart: unless-stopped
    networks:
      - traefik_proxy
    
    environment:
      - SOCKUDO_CONFIG_BASE64=${SOCKUDO_CONFIG_BASE64}
      - HOST=0.0.0.0
      - PORT=6001
      - RUST_LOG=info
      - DATABASE_REDIS_HOST=redis
      - DATABASE_REDIS_PORT=6379

    depends_on:
      - redis
    
    # Script kh·ªüi ƒë·ªông (Gi·ªØ nguy√™n logic ƒë√£ fix tr∆∞·ªõc ƒë√≥)
    command: >
      sh -c "
        mkdir -p /app/config && 
        
        if [ -n \"$$SOCKUDO_CONFIG_BASE64\" ]; then
          echo 'Found config in env, decoding...' &&
          echo \"$$SOCKUDO_CONFIG_BASE64\" | base64 -d > /app/config/production.json &&
          echo 'Config decoded successfully'
        else
          echo '‚ùå ERROR: SOCKUDO_CONFIG_BASE64 env var is empty!'
        fi &&

        echo 'üöÄ Starting Sockudo...' &&
        
        if [ -f /usr/local/bin/sockudo ]; then
          exec /usr/local/bin/sockudo --config /app/config/production.json
        elif [ -f /app/sockudo ]; then
           exec /app/sockudo --config /app/config/production.json
        else
           echo '‚ö†Ô∏è Binary not found, attempting PATH...'
           exec sockudo --config /app/config/production.json
        fi
      "

    labels:
      - "traefik.enable=true"
      
      # === C·∫§U H√åNH ƒêA DOMAIN (Dynamic) ===
      # B·∫Øt t·∫•t c·∫£ c√°c host b·∫Øt ƒë·∫ßu b·∫±ng "vg-signal."
      # V√≠ d·ª•: vg-signal.petplus.vn, vg-signal.phanmemvet.vn
      - "traefik.http.routers.${SERVICE_NAME}.rule=HostRegexp(`^vg-signal\\..+`)"
      
      - "traefik.http.routers.${SERVICE_NAME}.entrypoints=web"
      - "traefik.http.routers.${SERVICE_NAME}.service=${SERVICE_NAME}-svc"
      
      # Kh√¥ng d√πng StripPrefix v√¨ ƒë√¢y l√† Subdomain
      - "traefik.http.routers.${SERVICE_NAME}.middlewares=default-cors@file"
      
      # Port container
      - "traefik.http.services.${SERVICE_NAME}-svc.loadbalancer.server.port=6001"

  redis:
    image: redis:7-alpine
    container_name: ${SERVICE_NAME}_redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    networks:
      - traefik_proxy
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

networks:
  traefik_proxy:
    external: true
