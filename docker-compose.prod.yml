version: '3.8'

services:
  app:
    image: ${DOCKERHUB_USERNAME}/${SERVICE_NAME}:latest
    container_name: ${SERVICE_NAME}
    restart: unless-stopped
    networks:
      - traefik_proxy # Dùng chung mạng này để tiết kiệm IP pool
    
    environment:
      # Inject Config
      - SOCKUDO_CONFIG_BASE64=${SOCKUDO_CONFIG_BASE64}
      
      # Fallback env vars
      - HOST=0.0.0.0
      - PORT=6001
      - RUST_LOG=info

      # Redis Config (Internal connection via service name)
      - DATABASE_REDIS_HOST=redis
      - DATABASE_REDIS_PORT=6379

    depends_on:
      - redis
    
    command: >
      sh -c "mkdir -p /app/config && 
             echo \"$SOCKUDO_CONFIG_BASE64\" | base64 -d > /app/config/production.json && 
             ./sockudo --config /app/config/production.json"

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${SERVICE_NAME}.rule=HostRegexp(`^cluster\\..+`) && PathPrefix(`/${SERVICE_NAME}`)"
      - "traefik.http.routers.${SERVICE_NAME}.entrypoints=web"
      - "traefik.http.routers.${SERVICE_NAME}.service=${SERVICE_NAME}-svc"
      - "traefik.http.routers.${SERVICE_NAME}.middlewares=strip-prefix-${SERVICE_NAME},default-cors@file"
      - "traefik.http.middlewares.strip-prefix-${SERVICE_NAME}.stripprefix.prefixes=/${SERVICE_NAME}"
      - "traefik.http.services.${SERVICE_NAME}-svc.loadbalancer.server.port=6001"

  redis:
    image: redis:7-alpine
    container_name: ${SERVICE_NAME}_redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    networks:
      - traefik_proxy # Dùng chung mạng với App
    # Không có labels -> Không public ra ngoài internet, an toàn.
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

networks:
  traefik_proxy:
    external: true
