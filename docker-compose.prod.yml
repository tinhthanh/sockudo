version: '3.8'

services:
  app:
    image: ${DOCKERHUB_USERNAME}/${SERVICE_NAME}:latest
    container_name: ${SERVICE_NAME}
    restart: unless-stopped
    networks:
      - traefik_proxy
    
    environment:
      - SOCKUDO_CONFIG_BASE64=${SOCKUDO_CONFIG_BASE64}
      - HOST=0.0.0.0
      - PORT=6001
      - RUST_LOG=info
      - DATABASE_REDIS_HOST=redis
      - DATABASE_REDIS_PORT=6379

    depends_on:
      - redis
    
    # === FIX L·ªñI INTERPOLATION ($ -> $$) ===
    # Docker Compose y√™u c·∫ßu d√πng $$ ƒë·ªÉ escape bi·∫øn shell
    command: >
      sh -c "
        mkdir -p /app/config && 
        echo \"$$SOCKUDO_CONFIG_BASE64\" | base64 -d > /app/config/production.json &&
        echo 'üîç Searching for sockudo binary...' &&
        SOCKUDO_BIN=$$(find / -name sockudo -type f | head -n 1) &&
        if [ -z \"$$SOCKUDO_BIN\" ]; then
          echo '‚ùå Error: sockudo binary not found inside container!';
          exit 1;
        fi &&
        echo \"‚úÖ Found binary at: $$SOCKUDO_BIN\" &&
        chmod +x \"$$SOCKUDO_BIN\" &&
        \"$$SOCKUDO_BIN\" --config /app/config/production.json
      "

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${SERVICE_NAME}.rule=HostRegexp(`^cluster\\..+`) && PathPrefix(`/${SERVICE_NAME}`)"
      - "traefik.http.routers.${SERVICE_NAME}.entrypoints=web"
      - "traefik.http.routers.${SERVICE_NAME}.service=${SERVICE_NAME}-svc"
      - "traefik.http.routers.${SERVICE_NAME}.middlewares=strip-prefix-${SERVICE_NAME},default-cors@file"
      - "traefik.http.middlewares.strip-prefix-${SERVICE_NAME}.stripprefix.prefixes=/${SERVICE_NAME}"
      - "traefik.http.services.${SERVICE_NAME}-svc.loadbalancer.server.port=6001"

  redis:
    image: redis:7-alpine
    container_name: ${SERVICE_NAME}_redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    networks:
      - traefik_proxy
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

networks:
  traefik_proxy:
    external: true
