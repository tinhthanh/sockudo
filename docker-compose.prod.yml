version: '3.8'

services:
  app:
    image: ${DOCKERHUB_USERNAME}/${SERVICE_NAME}:latest
    container_name: ${SERVICE_NAME}
    restart: unless-stopped
    networks:
      - traefik_proxy
    
    environment:
      - SOCKUDO_CONFIG_BASE64=${SOCKUDO_CONFIG_BASE64}
      - HOST=0.0.0.0
      - PORT=6001
      - RUST_LOG=info
      - DATABASE_REDIS_HOST=redis
      - DATABASE_REDIS_PORT=6379

    depends_on:
      - redis
    
    # === FIX L·ªñI PERMISSION ===
    # 1. B·ªè l·ªánh find / (g√¢y ·ªìn log)
    # 2. B·ªè l·ªánh chmod (g√¢y l·ªói permission)
    # 3. Tr·ªè tr·ª±c ti·∫øp v√†o ƒë∆∞·ªùng d·∫´n ƒë√£ bi·∫øt (/usr/local/bin/sockudo) ho·∫∑c t√¨m trong PATH
    command: >
      sh -c "
        mkdir -p /app/config && 
        echo \"$$SOCKUDO_CONFIG_BASE64\" | base64 -d > /app/config/production.json &&
        
        echo 'üöÄ Starting Sockudo...' &&
        
        if [ -f /usr/local/bin/sockudo ]; then
          echo '‚úÖ Found binary at /usr/local/bin/sockudo'
          exec /usr/local/bin/sockudo --config /app/config/production.json
        elif [ -f /app/sockudo ]; then
           echo '‚úÖ Found binary at /app/sockudo'
           exec /app/sockudo --config /app/config/production.json
        else
           echo '‚ö†Ô∏è Binary not found in standard paths, attempting to run from PATH...'
           exec sockudo --config /app/config/production.json
        fi
      "

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${SERVICE_NAME}.rule=HostRegexp(`^cluster\\..+`) && PathPrefix(`/${SERVICE_NAME}`)"
      - "traefik.http.routers.${SERVICE_NAME}.entrypoints=web"
      - "traefik.http.routers.${SERVICE_NAME}.service=${SERVICE_NAME}-svc"
      - "traefik.http.routers.${SERVICE_NAME}.middlewares=strip-prefix-${SERVICE_NAME},default-cors@file"
      - "traefik.http.middlewares.strip-prefix-${SERVICE_NAME}.stripprefix.prefixes=/${SERVICE_NAME}"
      - "traefik.http.services.${SERVICE_NAME}-svc.loadbalancer.server.port=6001"

  redis:
    image: redis:7-alpine
    container_name: ${SERVICE_NAME}_redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    networks:
      - traefik_proxy
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

networks:
  traefik_proxy:
    external: true
